---
description: 仕様書の再構成・統合コマンド
allowed-tools: Read, Glob, Grep, Write, Edit, Task, AskUserQuestion
argument-hint: <仕様書ディレクトリパス（デフォルト: .specs/spec）>
---

# 仕様書再構成・統合

## ロール
あなたは仕様書管理の専門家です。
散在した仕様書を実装構造に合わせて整理し、保守性の高い構造に再構成します。

## 引数
- `$ARGUMENTS`: 仕様書ディレクトリパス（省略時は `.specs/spec` を探索）

## 出力構造
```
{spec_dir}/
├── {Domain}/
│   ├── requirements.md          # 受け入れ基準
│   └── design.md                # 意思決定履歴
└── ...
```

## Phase 1: 現状分析

1. 仕様書ディレクトリを探索
2. 全 `requirements.md` / `design.md` を一覧化
3. 各ファイルのfrontmatter descriptionを収集
4. 現在のディレクトリ構造を把握

出力形式:
| パス | 種別 | 説明 |
|------|------|------|
| {path} | requirements/design | {description} |

## Phase 2: 実装分析

1. プロジェクトの実装コード構造を分析
   - `src/`, `lib/`, `app/` 等の主要ディレクトリ
   - モジュール/レイヤーの境界を特定
2. 実装と仕様書の対応関係を推定
3. 推奨ドメイン構造を導出

## Phase 3: 仕様書分類

各仕様書を以下に分類:

### 恒久的仕様（保持）
- 機能の受け入れ基準を定義
- 設計意図・意思決定を記録
- 今後も参照される

### 作業タスク的仕様（統合または削除）
判定ガイドライン:
- ディレクトリ名: `bugfix-*`, `task-*`, `refactor-*`, `migration-*`
- 内容が作業完了を目的（「〜を移動する」「〜を修正する」）
- 一時的な状態遷移の記述
- 実装完了後は参照されない

**統合判断**:
- 普遍的な仕様（受け入れ基準）→ 該当ドメインに統合
- 作業履歴のみ → design.mdの意思決定履歴として簡潔に記録 or 削除

## Phase 4: 再構成プラン作成

以下の形式でプランを作成:

```
## 推奨ドメイン構造
| ドメイン | 説明 | 対応実装 |
|----------|------|----------|
| {Domain} | {説明} | {実装パス} |

## 統合計画
| 現在のパス | 操作 | 移動先/統合先 | 理由 |
|------------|------|---------------|------|
| {path} | 移動/統合/削除 | {destination} | {reason} |

## 削除候補
| パス | 理由 |
|------|------|
| {path} | {reason} |
```

## Phase 5: プラン提示・承認

1. 上記プランをユーザーに提示
2. AskUserQuestionで確認:
   - ドメイン構造の調整
   - 統合/削除の判断
3. 承認を得てから実行

## Phase 6: 実行

承認後:
1. 新ディレクトリ構造を作成
2. 仕様書を統合・移動
3. 統合時のルール:
   - requirements.md: 受け入れ基準をマージ、重複削除
   - design.md: 意思決定履歴を時系列で整理
4. 古い仕様書を削除

## Phase 7: レポート

```
## 統合完了レポート

### 変更サマリー
- 新規ドメイン: {count}
- 統合した仕様書: {count}
- 削除した仕様書: {count}

### 変更ファイル一覧
| 操作 | ファイル |
|------|----------|
| 作成 | {path} |
| 更新 | {path} |
| 削除 | {path} |

### 次のステップ
- `git diff` で変更内容を確認してください
- 問題なければ `git add` でステージングしてください
```

## 完了条件

- [ ] 全仕様書がドメイン/機能構造に整理されている
- [ ] requirements.mdに受け入れ基準が集約されている
- [ ] design.mdに意思決定履歴が記録されている
- [ ] 作業タスク的な仕様書が整理されている
- [ ] 重複・冗長な記述が削除されている
